// Slick carousel module
//
var carousel = function() {
  var slickEls = document.querySelectorAll('.slick');
  slickEls.forEach(function(element) {
    var arrows = element.hasAttribute("data-arrows");
    var dots = element.hasAttribute("data-dots");
    var carouselName = element.getAttribute("data-carousel-name");

    $(element).slick({
      arrows: arrows,
      dots: dots,
      draggable: true,
      accessibility: true,
      responsive: [{
        breakpoint: 560,
        settings: {
          dots: false,
          arrows: false
        }
      },
      {
        breakpoint: 1025,
        settings: {
          arrows: false
        }
      }]
    });

    // Accessibility
    // Add ability to move through carousel
    //
    $(element).on('keydown', function(e) {
      var keyCode = e.which;
      if ((keyCode === 13) || (keyCode === 32)) {
        e.preventDefault();
        $(this).slick('slickNext');
      }
    });
  });
}();

(function(){
  var startedWithMinutes = null;

  // This number *never* changes
  var developerSecondsSavedBeforeAnalyticIngester = 26304323354;

  // These numbers are taken from our SQL query
  var developerSecondsSavedAfterAnalyticIngester = 4292012226;
  var developerSecondsSavedPerSecond = 560;
  var timeUpdated = 1499885116;

  var domTarget = document.querySelector('.hero__hours-counter__counter');

  function reloadThis() {
    // get current time
    // get difference in seconds from timeUpdated
    // multiply difference in seconds by developerSecondsSavedPerSecond
    // add to sum of developerSecondsSavedBefore and After

    var currentEpoch = ((new Date()).getTime()) / 1000;

    var developerSecondsSavedSinceUpdate = (currentEpoch - timeUpdated) * developerSecondsSavedPerSecond;
    var seconds = developerSecondsSavedSinceUpdate + developerSecondsSavedBeforeAnalyticIngester + developerSecondsSavedAfterAnalyticIngester;

    var minutes = seconds / 60; // to minutes
    if (startedWithMinutes === null) {
      startedWithMinutes = minutes;
    }
    var hours = minutes / 60; // to hours
    var hoursAsArray = parseInt(hours).toString().split('');
    var outputHtml = '';
    var hoursOutput = [];
    hoursAsArray.reverse();

    for (var i = 0; i < hoursAsArray.length; i++) {
      if ((i !== 0) && (i % 3 === 0)) {
        hoursOutput[i] = '<span>'+ hoursAsArray[i] +'</span><span class="comma">,</span>';
      }else{
        hoursOutput[i] = '<span>'+ hoursAsArray[i] +'</span>';
      }
    }

    hoursOutput.reverse();
    for (var a = 0; a < hoursOutput.length; a++) {
      outputHtml += hoursOutput[a] ;
    }
    domTarget.innerHTML = outputHtml;
  }
  reloadThis();
  setInterval(reloadThis, 10000);
})();
/**
 * @fileoverview
 * Handles the intersection observation for the "how it works" section
 * and applies necessary animation triggers.
 */
(function(){  
  var target = document.querySelector('.typeahead');

  var io = new IntersectionObserver(function(e) {
    var inView = e.find(function(i) {
      return i.isIntersecting;
    });
    if (inView) {
      connectAnimations();
    }
  });

  io.observe(target);

  function connectAnimations() {
    var BETA = 'beta';
    var APPSTORE = 'appstore';

    var currentActive = BETA;

    var stepsContainer = document.querySelector('.animation__steps');

    var betaCode = document.getElementById('beta');
    var betaSteps = document.getElementById('steps-beta');

    var appStoreCode = document.getElementById('appstore');
    var appstoreSteps = document.getElementById('steps-appstore');

    // Typeahead element
    var whichType = document.querySelector('.typeahead__target');

    setInterval(function() {
      if (currentActive == APPSTORE) {
        appStoreCode.classList.remove('active');
        appstoreSteps.classList.remove('active');

        stepsContainer.classList.remove('expanded')
        betaCode.classList.add('active');
        betaSteps.classList.add('active');
        whichType.textContent = BETA;
        currentActive = BETA;
      } else if (currentActive == BETA) {
        appStoreCode.classList.add('active');
        appstoreSteps.classList.add('active');

        stepsContainer.classList.add('expanded');
        betaCode.classList.remove('active');
        betaSteps.classList.remove('active');
        whichType.textContent = APPSTORE;
        currentActive = APPSTORE;
      }
    }, 4000);
  }
})();
(function(){
  // Init YouTube player
  var tag = document.createElement('script');

  tag.src = 'https://www.youtube.com/iframe_api';
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Add mobile class
  if (/ip(ad|hone|od)|android/i.test(window.navigator.userAgent)) {
    document.body.classList.add('mobile');
  }
})();

(function(){
  var BETA_STR_ = 'beta'.split();
  var DEPLOY_STR_ = 'appstore'.split();

  var target = document.querySelector('.typeahead__target');
  
})();
/**
 * @fileoverview
 * This connects modal functionality and YouTube embedding for the
 * "how it works" section.  On non-mobile devices, the video will open in
 * a modal window.  For mobile devices, it will act as every other YT embed
 * as to not interfere with the normal UX.
 */
var player;
// Kicks off the process.
function onYouTubeIframeAPIReady() {
  player = new YT.Player('yt-player', {
    width: '100%',
    height: '100%',
    videoId: 'wOtANfkh2bI',
    events: {
      onReady: $fastlaneYT.onPlayerReady,
      onStateChange: $fastlaneYT.onPlayerStateChange
    }
  });
}
window.$fastlaneYT = (function() {

// Kicks off the process.
function onYouTubeIframeAPIReady() {
  player = new YT.Player('yt-player', {
    width: '100%',
    height: '100%',
    videoId: 'seoY2-hm7lQ',
    events: {
      onReady: $fastlaneYT.onPlayerReady,
      onStateChange: $fastlaneYT.onPlayerStateChange
    }
  });
}
window.$fastlaneYT = (function() {

  // Constants
  var MAX_WIDTH_PERC_ = 0.25;
  var EXPAND_DURATION_ = 0.45; // seconds

  // @todo(sgeer): Better mobile detection
  var ratio = 16 / 9;

  return {
    onPlayerReady: initModal
  };

  /**
   * Sets up event listeners, etc for modal interaction.
   */
  function initModal(player) {
    var isMobile = document.body.classList.contains('mobile');
    return isMobile ? setupMobilePlayer(player.target) : setupModalPlayer(player.target);
  }

  /**
   * Don't interrupt the normal mobile YouTube player flow if the user is
   * on a device.
   */
  function setupMobilePlayer(player) {
    console.info('Setting up mobile player.')
  }

  /**
   * If we have an idea the user isn't on a mobile device, set up the
   * modal functionality.
   */
  function setupModalPlayer(player) {
    player.setPlaybackQuality('hd720');

    var modalContainer = document.querySelector('.video-modal');
    var vMedia = document.querySelector('.video-modal__media');
    var ytDom = document.getElementById('yt-player');
    var closeButton = document.querySelector('.video-modal__close span');
    var backdrop = createBackdrop_();

    var modalWidth = modalContainer.offsetWidth;
    var modalHeight = modalContainer.offsetHeight;

    var winWidth = window.innerWidth;
    var winHeight = window.innerHeight;
    var maxWidth = winWidth - winWidth * MAX_WIDTH_PERC_;
    var maxHeight = maxWidth / ratio;

    modalContainer.addEventListener('click', openModal);
    document.addEventListener('click', checkModalClose);
    window.addEventListener('keyup', closeModal);
    closeButton.addEventListener('click', closeModal.bind(this, null, true));

    /**
     * Open the video modal.
     * @param {MouseEvent} e
     */
    function openModal(e) {
  var ratio = 16 / 9;

  return {
    onPlayerReady: initModal
  };

  /**
   * Sets up event listeners, etc for modal interaction.
   */
  function initModal(player) {
    return PLATFORM_MOBILE_ ? setupMobilePlayer() : setupModalPlayer(player.target);
  }

  /**
   * Don't interrupt the normal mobile YouTube player flow if the user is
   * on a device.
   */
  function setupMobilePlayer() {
    console.info('Setting up mobile player.')
  }

  /**
   * If we have an idea the user isn't on a mobile device, set up the
   * modal functionality.
   */
  function setupModalPlayer(player) {
    player.setPlaybackQuality('hd720');

    var modalContainer = document.querySelector('.video-modal');
    var vMedia = document.querySelector('.video-modal__media');
    var ytDom = document.getElementById('yt-player');

    var modalWidth = modalContainer.offsetWidth;
    var modalHeight = modalContainer.offsetHeight;

    var winWidth = window.innerWidth;
    var winHeight = window.innerHeight;
    var maxWidth = winWidth - winWidth * MAX_WIDTH_PERC_;
    var maxHeight = maxWidth / ratio;

    modalContainer.addEventListener('click', openModal);
    document.addEventListener('click', checkModalClose);
    window.addEventListener('keyup', closeModal);

    /**
       * Open the video modal.
       * @param {MouseEvent} e
       */
    function onVideoClick(e) {
      var pos = modalContainer.getBoundingClientRect();
      var x = pos.left;
      var y = pos.top;

      vMedia.style.display = 'block';
      vMedia.style.left = x + 'px';
      vMedia.style.top = y + 'px';
      backdrop.style.display = 'block';

      var END_WIDTH_ = maxWidth + 'px';
      var END_HEIGHT_ = maxWidth / ratio + 'px';

      TweenMax.to(vMedia, EXPAND_DURATION_, {
        width: END_WIDTH_,
        height: END_HEIGHT_,
        opacity: 1,
        left: (winWidth - maxWidth) / 2 + 'px',
        top: (winHeight - maxHeight) / 2 + 'px',
        ease: Power2.easeInOut,
        onComplete: onModalOpen
      });

      TweenMax.to(backdrop, EXPAND_DURATION_, {
        opacity: 1
      })
    }

    /**
     * Close the modal and return to natural position.
     * Callback from ESC keypress
     * @param {KeyboardEvent} e
     */
    function closeModal(e, force) {
      if (force === true || e.keyCode == 27) {
        player.pauseVideo();

        var pos = modalContainer.getBoundingClientRect();
        var x = pos.left;
        var y = pos.top;

        TweenMax.to(vMedia, EXPAND_DURATION_, {
          width: modalWidth + 'px',
          height: modalHeight + 'px',
          left: x + 'px',
          top: y + 'px',
          opacity: 0,
          ease: Power2.easeInOut,
          onComplete: onModalClose
        });

        TweenMax.to(backdrop, EXPAND_DURATION_, {
          opacity: 0,
          onComplete: function() {
            backdrop.style.display = 'none';
          }
        })
      }
    }

    /**
     * Callback for clicking elsewhere on the document to close the modal.
     * @todo(sgeer)
     */
    function checkModalClose(e) {
      if (e.target.classList.contains('video-modal__backdrop')) {
        closeModal(null, true);
      }
    }

    /**
     * onComplete callback for opening the modal.
     */
    function onModalOpen() {
      ytDom.style.display = 'block';
      vMedia.style.display = 'block';
      player.playVideo();
    function checkModalClose() {
      return false;
    }

    /**
     * onComplete callback for opening the modal.
     */
    function onModalOpen() {
      ytDom.style.display = 'block';
      vMedia.style.display = 'block';
      return TweenMax.to(ytDom, EXPAND_DURATION_, {
        opacity: 1
      });
    }

    function onModalClose() {
      return TweenMax.to(ytDom, EXPAND_DURATION_, {
        opacity: 0,
        onComplete: function() {
          ytDom.style.display = 'none';
          vMedia.style.display = 'none';
        }
      });
    }

    function createBackdrop_() {
      var div = document.createElement('div');
      div.classList.add('video-modal__backdrop');
      document.body.appendChild(div);
      return div;
    }
  }
})();
